<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Break Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 font-sans">

<!-- LOGIN PAGE -->
<div id="loginPage" class="flex flex-col items-center justify-center min-h-screen">
  <div class="bg-white rounded-xl shadow p-8 w-full max-w-md">
    <h2 class="text-3xl font-bold text-center mb-6 text-[#0d141b]">Break Tracker Login</h2>
    <label class="block mb-4">
      <p class="mb-2 font-medium text-[#0d141b]">Email</p>
      <input id="email" type="email" placeholder="Enter your email" class="w-full p-3 rounded-lg border-none bg-[#e7edf3] placeholder:text-[#4c739a]" />
    </label>
    <label class="block mb-4">
      <p class="mb-2 font-medium text-[#0d141b]">Password</p>
      <input id="password" type="password" placeholder="Enter your password" class="w-full p-3 rounded-lg border-none bg-[#e7edf3] placeholder:text-[#4c739a]" />
    </label>
    <button onclick="login()" class="w-full bg-[#1172d4] text-white py-3 rounded-lg font-bold">Login</button>
  </div>
</div>

<!-- BREAK OVERVIEW PAGE -->
<div id="overviewPage" class="hidden min-h-screen p-6">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Team Break Overview</h2>
    <button class="bg-red-500 text-white px-4 py-2 rounded" onclick="logout()">Logout</button>
  </div>

  <table class="w-full border-collapse border border-gray-200">
    <thead>
      <tr class="bg-gray-100">
        <th class="border px-4 py-2">Employee</th>
        <th class="border px-4 py-2">Status</th>
        <th class="border px-4 py-2">Total Break Used</th>
        <th class="border px-4 py-2">Action</th>
      </tr>
    </thead>
    <tbody id="teamTable"></tbody>
  </table>
</div>

<script>
  // ======= USERS =======
  const users = [
    { email: "d.kamesh@opendoor.com", password: "9597752296", name: "Kamesh D" },
    { email: "Manikandan.m@opendoor.com", password: "123456789", name: "Manikandan M" }
  ];

  let currentUser = null;
  let breakData = {};

  async function fetchBreakData() {
    const res = await fetch('http://localhost:3000/breakData');
    breakData = await res.json();
    renderTable();
  }

  function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();

    const user = users.find(u => u.email === email && u.password === password);
    if(user) {
      currentUser = user.name;
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("overviewPage").classList.remove("hidden");
      fetchBreakData();
      // refresh every 5 sec
      setInterval(fetchBreakData, 5000);
    } else {
      alert("Invalid email or password!");
    }
  }

  function logout() {
    currentUser = null;
    location.reload();
  }

  async function breakIn(agent) {
    const res = await fetch('http://localhost:3000/breakIn', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: agent })
    });
    await res.json();
    fetchBreakData();
  }

  async function breakOut(agent) {
    const res = await fetch('http://localhost:3000/breakOut', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: agent })
    });
    await res.json();
    fetchBreakData();
  }

  function renderTable() {
    const tableBody = document.getElementById("teamTable");
    tableBody.innerHTML = '';

    Object.keys(breakData).forEach(agent => {
      const info = breakData[agent];
      const remaining = Math.max(60 - info.totalBreak, 0);

      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="border px-4 py-2">${agent}</td>
        <td class="border px-4 py-2">${info.status}</td>
        <td class="border px-4 py-2">${formatMinutes(info.totalBreak)}</td>
        <td class="border px-4 py-2">
          ${agent === currentUser ? `
            ${info.status==="Working" && remaining>0 ? `<button class="bg-green-500 text-white px-3 py-1 rounded" onclick="breakIn('${agent}')">Break In</button>` : ''}
            ${info.status==="On Break" ? `<button class="bg-red-500 text-white px-3 py-1 rounded" onclick="breakOut('${agent}')">Break Out</button>` : ''}
          ` : '-'}
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  function formatMinutes(mins) {
    const h = Math.floor(mins / 60).toString().padStart(2,'0');
    const m = (mins % 60).toString().padStart(2,'0');
    return `${h}:${m}`;
  }
</script>
</body>
</html>
